{% extends 'base.html' %}
{% load static %}


{% block meta %}
<title>Register - KickEleven</title>
{% endblock meta %}

{% block content %}
<div class="form-style">
  <div class="min-h-screen flex items-center justify-center p-8 bg-cover bg-center"
     style="background-image: url('{% static "image/newlogin.png" %}');">
    <div class="max-w-md w-full relative z-10">
      <div class="bg-blue-100 border border-[#2A4B7C] rounded-lg p-8 shadow-sm">
      <div class="text-center mb-8">
        <h1 class="text-2xl font-semibold text-[#163599] mb-2">Join Us</h1>
        <p class="text-[#163599]">Create your account</p>
      </div>
      
      <!-- Form Errors Display -->
      {% if form.non_field_errors %}
        <div class="mb-6">
          {% for error in form.non_field_errors %}
            <div class="px-4 py-3 rounded text-sm border bg-red-50 border-red-200 text-red-700">
              {{ error }}
            </div>
          {% endfor %}
        </div>
      {% endif %}

      {% if form.errors %}
        <div class="mb-6">
          {% for field, errors in form.errors.items %}
            {% if field != '__all__' %}
              {% for error in errors %}
                <div class="px-4 py-3 rounded text-sm border bg-red-50 border-red-200 text-red-700 mb-2">
                  <strong>{{ field|title }}:</strong> {{ error }}
                </div>
              {% endfor %}
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}

      <!-- Error Message -->
      <div id="errorMessage" class="hidden mb-4 rounded-lg bg-red-50 p-4 border border-red-200">
        <div class="flex">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            </svg>
          </div>
          <div class="ml-3">
            <ul id="errorList" class="text-sm text-red-800 list-disc list-inside space-y-1"></ul>
          </div>
        </div>
      </div>

      <form id="registerForm" method="POST" action="" class="space-y-5">
        {% csrf_token %}
        
        <div>
          <label for="username" class="block text-sm font-medium text-[#163599] mb-2">Username</label>
          <input 
            id="username" 
            name="username" 
            type="text" 
            required 
            class="w-full px-4 py-3 border !border-blue-800 rounded focus:outline-none focus:!border-green-500 transition duration-200" 
            placeholder="Choose a username">
          <p class="mt-1 text-xs text-gray-500">150 characters or fewer. Letters, digits and @/./+/-/_ only.</p>
        </div>

        <div>
          <label for="password1" class="block text-sm font-medium text-[#163599] mb-2">Password</label>
          <input 
            id="password1" 
            name="password1" 
            type="password" 
            required 
            class="w-full px-4 py-3 border !border-blue-800 rounded focus:outline-none focus:!border-green-500 transition duration-200" 
            placeholder="Create a password">
        </div>

        <div>
          <label for="password2" class="block text-sm font-medium text-[#163599] mb-2">Confirm Password</label>
          <input 
            id="password2" 
            name="password2" 
            type="password" 
            required 
            class="w-full px-4 py-3 border !border-blue-800 rounded focus:outline-none focus:!border-green-500 transition duration-200" 
            placeholder="Confirm your password">
        </div>

        <button 
          type="submit" 
          id="registerButton"
          class="w-full bg-[#163599] text-[#FFFFFF] font-medium py-3 px-4 rounded hover:bg-[#ABDFFF] focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-200 flex items-center justify-center">
          <span id="registerButtonText">Create Account</span>
          <span id="registerSpinner" class="hidden ml-2">
            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </span>
        </button>
      </form>

      <!-- Messages Display -->
      {% if messages %}
        <div class="mt-6">
          {% for message in messages %}
            <div 
              class="
                px-4 py-3 rounded text-sm border
                {% if message.tags == 'success' %}
                  bg-green-50 border-green-200 text-green-700
                {% elif message.tags == 'error' %}
                  bg-red-50 border-red-200 text-red-700
                {% else %}
                  bg-gray-50 border-gray-200 text-gray-700
                {% endif %}
              ">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <div class="mt-6 text-center">
          <p class="text-[#2C395E] text-sm">
            Already have an account? 
            <a href="{% url 'main:login' %}" class="text-[#163599] hover:text-blue-300 font-medium">
            Sign In 
            </a>
          </p>
        </div>
        </div>
      </div>
    </div>
  </div>

<!-- Toast Component -->
<div id="toast-component" class="fixed bottom-5 right-5 flex items-center gap-3 px-6 py-4 rounded-xl shadow-2xl transform translate-y-64 opacity-0 transition-all duration-500 ease-out z-50 border-l-4">
  <span id="toast-icon" class="text-2xl"></span>
  <p id="toast-title" class="font-semibold text-sm"></p>
</div>

<script src="{% static 'js/toast.js' %}"></script>
<script>
document.getElementById('registerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const registerButton = document.getElementById('registerButton');
    const registerButtonText = document.getElementById('registerButtonText');
    const registerSpinner = document.getElementById('registerSpinner');
    const errorMessage = document.getElementById('errorMessage');
    const errorList = document.getElementById('errorList');
    
    // Disable button dan show spinner
    registerButton.disabled = true;
    registerButtonText.textContent = 'Creating account...';
    registerSpinner.classList.remove('hidden');
    errorMessage.classList.add('hidden');
    errorList.innerHTML = '';
    
    const formData = new FormData(this);
    
    try {
        const response = await fetch("{% url 'main:register_ajax' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showToast('Account created successfully! ðŸŽ‰', 'success', 2000);
            
            // Redirect ke login setelah 1.5 detik
            setTimeout(() => {
                window.location.href = "{% url 'main:login' %}";
            }, 1500);
        } else {
            // Show error messages
            if (data.errors) {
                Object.values(data.errors).forEach(errorArray => {
                    errorArray.forEach(error => {
                        const li = document.createElement('li');
                        li.textContent = error;
                        errorList.appendChild(li);
                    });
                });
            } else if (data.message) {
                const li = document.createElement('li');
                li.textContent = data.message;
                errorList.appendChild(li);
            }
            
            errorMessage.classList.remove('hidden');
            showToast('Registration failed. Please check the form.', 'error');
            
            // Reset button
            registerButton.disabled = false;
            registerButtonText.textContent = 'Create Account';
            registerSpinner.classList.add('hidden');
        }
    } catch (error) {
        console.error('Error:', error);
        const li = document.createElement('li');
        li.textContent = 'An error occurred. Please try again.';
        errorList.appendChild(li);
        errorMessage.classList.remove('hidden');
        showToast('Connection error. Please try again.', 'error');
        
        // Reset button
        registerButton.disabled = false;
        registerButtonText.textContent = 'Create Account';
        registerSpinner.classList.add('hidden');
    }
});
</script>
{% endblock content %}