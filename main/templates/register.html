{% extends 'base.html' %}
{% load static %}


{% block meta %}
<title>Register - KickEleven</title>
{% endblock meta %}

{% block content %}
<div class="form-style">
  <div class="min-h-screen flex items-center justify-center p-8 bg-cover bg-center"
     style="background-image: url('{% static "image/newlogin.png" %}');">
    <div class="max-w-md w-full relative z-10">
      <div class="bg-blue-100 border border-[#2A4B7C] rounded-lg p-8 shadow-sm">
      <div class="text-center mb-8">
        <h1 class="text-2xl font-semibold text-[#163599] mb-2">Join Us</h1>
        <p class="text-[#163599]">Create your account</p>
      </div>
      
      <!-- Form Errors Display -->
      {% if form.non_field_errors %}
        <div class="mb-6">
          {% for error in form.non_field_errors %}
            <div class="px-4 py-3 rounded text-sm border bg-red-50 border-red-200 text-red-700">
              {{ error }}
            </div>
          {% endfor %}
        </div>
      {% endif %}

      {% if form.errors %}
        <div class="mb-6">
          {% for field, errors in form.errors.items %}
            {% if field != '__all__' %}
              {% for error in errors %}
                <div class="px-4 py-3 rounded text-sm border bg-red-50 border-red-200 text-red-700 mb-2">
                  <strong>{{ field|title }}:</strong> {{ error }}
                </div>
              {% endfor %}
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}

      <form method="POST" action="" class="space-y-5">
        {% csrf_token %}
        
        <div>
          <label for="username" class="block text-sm font-medium text-[#163599] mb-2">Username</label>
          <input 
            id="username" 
            name="username" 
            type="text" 
            required 
            class="w-full px-4 py-3 border !border-blue-800 rounded focus:outline-none focus:!border-green-500 transition duration-200" 
            placeholder="Choose a username">
        </div>

        <div>
          <label for="password1" class="block text-sm font-medium text-[#163599] mb-2">Password</label>
          <input 
            id="password1" 
            name="password1" 
            type="password" 
            required 
            class="w-full px-4 py-3 border !border-blue-800 rounded focus:outline-none focus:!border-green-500 transition duration-200" 
            placeholder="Create a password">
        </div>

        <div>
          <label for="password2" class="block text-sm font-medium text-[#163599] mb-2">Confirm Password</label>
          <input 
            id="password2" 
            name="password2" 
            type="password" 
            required 
            class="w-full px-4 py-3 border !border-blue-800 rounded focus:outline-none focus:!border-green-500 transition duration-200" 
            placeholder="Confirm your password">
        </div>

        <button 
          type="submit" 
          class="w-full bg-[#163599] text-[#FFFFFF] font-medium py-3 px-4 rounded hover:bg-[#ABDFFF] focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-200">
          Create Account
        </button>
      </form>

      <!-- Messages Display -->
      {% if messages %}
        <div class="mt-6">
          {% for message in messages %}
            <div 
              class="
                px-4 py-3 rounded text-sm border
                {% if message.tags == 'success' %}
                  bg-green-50 border-green-200 text-green-700
                {% elif message.tags == 'error' %}
                  bg-red-50 border-red-200 text-red-700
                {% else %}
                  bg-gray-50 border-gray-200 text-gray-700
                {% endif %}
              ">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <div class="mt-6 text-center">
          <p class="text-[#2C395E] text-sm">
            Already have an account? 
            <a href="{% url 'main:login' %}" class="text-[#163599] hover:text-blue-300 font-medium">
            Sign In 
            </a>
          </p>
        </div>
        </div>
      </div>
    </div>
  </div>

<script>
(function () {
  // safe toast helper
  function showToastSafe(message, type = 'normal') {
    if (typeof showToast === 'function') {
      showToast(message, type);
    } else {
      console.log(`[${type.toUpperCase()}] ${message}`);
    }
  }

  function getCookie(name) {
    const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
  }

  // cari form register
  let form = document.getElementById('registerForm');
  if (!form) {
    const forms = document.getElementsByTagName('form');
    for (let f of forms) {
      if (f.querySelector('input[name="username"]')) {
        form = f;
        break;
      }
    }
  }
  if (!form) {
    console.warn('register-ajax: form register tidak ditemukan');
    return;
  }

  // elemen error minimal
  let errorEl = document.getElementById('registerError');
  if (!errorEl) {
    errorEl = document.createElement('div');
    errorEl.id = 'registerError';
    errorEl.className = 'hidden text-sm text-red-600 whitespace-pre-line mt-3';
    form.parentNode.insertBefore(errorEl, form.nextSibling);
  }

  const submitBtn = form.querySelector('button[type="submit"], input[type="submit"]');

  form.addEventListener('submit', async function (e) {
    e.preventDefault();
    errorEl.classList.add('hidden');
    errorEl.textContent = '';

    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.classList.add('opacity-70', 'cursor-not-allowed');
    }

    try {
      const fdOrig = new FormData(form);

      // ambil nilai password dari berbagai kemungkinan nama input
      const pw1 = (fdOrig.get('password1') ?? fdOrig.get('password') ?? fdOrig.get('password_1') ?? '').toString();
      const pw2 = (fdOrig.get('password2') ?? fdOrig.get('password_confirm') ?? fdOrig.get('confirm_password') ?? fdOrig.get('password_2') ?? '').toString();

      // client-side validation: wajib, dan harus sama
      if (!pw1 || !pw2) {
        const msg = 'Password dan konfirmasi password wajib diisi.';
        errorEl.textContent = msg;
        errorEl.classList.remove('hidden');
        showToastSafe(msg, 'error');
        return;
      }

      if (pw1 !== pw2) {
        const msg = 'Password tidak sama. Mohon periksa kembali.';
        errorEl.textContent = msg;
        errorEl.classList.remove('hidden');
        showToastSafe(msg, 'error');
        return;
      }

      // Siapkan FormData yang dikirim ke server.
      // Kirim username jika ada, dan kirim password1/password2 (standar Django) plus password sebagai fallback.
      const fd = new FormData();
      if (fdOrig.has('username')) fd.append('username', fdOrig.get('username'));
      // gunakan nama-field yang umum dipakai server-side
      fd.append('password1', pw1);
      fd.append('password2', pw2);
      // fallback: jika server mengharapkan 'password'
      fd.append('password', pw1);

      const url = "{% url 'main:register_ajax' %}";

      const resp = await fetch(url, {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'X-CSRFToken': getCookie('csrftoken') },
        body: fd
      });

      if (resp.ok) {
        const data = await resp.json().catch(() => ({}));
        showToastSafe('Your account has been successfully created!', 'success');
        sessionStorage.setItem('toastFlag', 'register');
        
        setTimeout(() => {
          window.location.href = "{% url 'main:login' %}";
        }, 800);
        return;
      } else {
        const data = await resp.json().catch(() => null);
        let message = 'Registrasi gagal.';
        if (data) {
          if (data.errors) {
            message = Object.values(data.errors).join('\n');
          } else if (data.detail) {
            message = data.detail;
          } else if (data.error) {
            message = data.error;
          }
        } else {
          message = 'Registrasi gagal (server error ' + resp.status + ')';
        }
        errorEl.textContent = message;
        errorEl.classList.remove('hidden');
        showToastSafe(message, 'error');
      }
    } catch (err) {
      console.error('Register error', err);
      const msg = 'Gagal terhubung ke server. Coba lagi.';
      errorEl.textContent = msg;
      errorEl.classList.remove('hidden');
      showToastSafe(msg, 'error');
    } finally {
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.classList.remove('opacity-70', 'cursor-not-allowed');
      }
    }
  });
})();
</script>
{% endblock content %}